name: Release

on:
  # Manual trigger only - for controlled releases
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.1.0)'
        required: true
        type: string
      skip_notarize:
        description: 'Skip macOS notarization (for testing)'
        required: false
        type: boolean
        default: false
      skip_sign:
        description: 'Skip code signing (for testing)'
        required: false
        type: boolean
        default: false
      create_github_release:
        description: 'Create GitHub Release with artifacts'
        required: false
        type: boolean
        default: true

# Ensure only one release build runs at a time
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Job 1: Pre-flight checks - Ensure CI is passing
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for clean git state
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "❌ ERROR: Working directory is not clean"
            echo "Please commit or stash all changes before creating a release"
            exit 1
          fi
          echo "✅ Working directory is clean"

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "❌ ERROR: Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix (e.g., 0.1.0 or 0.1.0-beta)"
            exit 1
          fi
          echo "✅ Version format valid: $VERSION"

      - name: Check if tag exists
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "⚠️ WARNING: Tag v$VERSION already exists"
            echo "This will overwrite the existing tag if release is created"
          else
            echo "✅ Tag v$VERSION does not exist (good)"
          fi

      - name: Verify parity checklist exists
        run: |
          if [[ ! -f "docs/qa/platform_parity_checklist.md" ]]; then
            echo "❌ ERROR: Platform parity checklist not found"
            echo "Expected: docs/qa/platform_parity_checklist.md"
            exit 1
          fi
          echo "✅ Platform parity checklist found"

      - name: Display release configuration
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Release Configuration"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Version:              ${{ github.event.inputs.version }}"
          echo "Skip macOS Notarize:  ${{ github.event.inputs.skip_notarize }}"
          echo "Skip Code Signing:    ${{ github.event.inputs.skip_sign }}"
          echo "Create GitHub Release: ${{ github.event.inputs.create_github_release }}"
          echo "Branch:               ${{ github.ref_name }}"
          echo "Commit:               ${{ github.sha }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  # Job 2: Build macOS release
  build-macos:
    name: Build macOS Release
    needs: preflight
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Import signing certificate (if signing enabled)
        if: ${{ github.event.inputs.skip_sign != 'true' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$MACOS_CERTIFICATE_PWD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign

          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Set as default keychain
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | sed s/\"//g)
          security default-keychain -s "$KEYCHAIN_PATH"

          rm certificate.p12

          echo "✅ Signing certificate imported"

      - name: Build macOS release DMG
        env:
          VERSION: ${{ github.event.inputs.version }}
          SKIP_NOTARIZE: ${{ github.event.inputs.skip_notarize }}
          SKIP_SIGN: ${{ github.event.inputs.skip_sign }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          AC_PASSWORD: ${{ secrets.AC_PASSWORD }}
          AC_PROVIDER: ${{ secrets.AC_PROVIDER }}
          SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          # Set flags based on inputs
          FLAGS="--version $VERSION"
          if [[ "$SKIP_NOTARIZE" == "true" ]]; then
            FLAGS="$FLAGS --skip-notarize"
          fi
          if [[ "$SKIP_SIGN" == "true" ]]; then
            FLAGS="$FLAGS --skip-sign"
          fi

          # Run build script
          bash scripts/ci/build_macos_release.sh $FLAGS

      - name: Upload macOS DMG artifact
        uses: actions/upload-artifact@v3
        with:
          name: WireTuner-macOS.dmg
          path: build/release/WireTuner-${{ github.event.inputs.version }}-macOS.dmg
          retention-days: 30

      - name: Upload macOS SHA256 hash
        uses: actions/upload-artifact@v3
        with:
          name: WireTuner-macOS.sha256
          path: build/release/WireTuner-${{ github.event.inputs.version }}-macOS.sha256
          retention-days: 30

      - name: Display build summary
        run: |
          DMG_PATH="build/release/WireTuner-${{ github.event.inputs.version }}-macOS.dmg"
          HASH_PATH="build/release/WireTuner-${{ github.event.inputs.version }}-macOS.sha256"

          if [[ -f "$DMG_PATH" ]]; then
            echo "✅ macOS DMG created successfully"
            echo "   Size: $(du -h "$DMG_PATH" | cut -f1)"
            echo "   SHA256: $(cat "$HASH_PATH")"
          else
            echo "❌ macOS DMG not found"
            exit 1
          fi

  # Job 3: Build Windows release
  build-windows:
    name: Build Windows Release
    needs: preflight
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v3
        with:
          path: ~\AppData\Local\Pub\Cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          # Refresh PATH to include Inno Setup
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          Write-Host "✅ Inno Setup installed"

      - name: Import signing certificate (if signing enabled)
        if: ${{ github.event.inputs.skip_sign != 'true' }}
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PWD: ${{ secrets.WINDOWS_CERTIFICATE_PWD }}
        shell: pwsh
        run: |
          # Decode and save PFX certificate
          $certBytes = [Convert]::FromBase64String($env:WINDOWS_CERTIFICATE)
          $certPath = Join-Path $env:RUNNER_TEMP "certificate.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          # Set environment variables for build script
          echo "WINDOWS_PFX_PATH=$certPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "WINDOWS_PFX_PASSWORD=$env:WINDOWS_CERTIFICATE_PWD" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          Write-Host "✅ Signing certificate prepared"

      - name: Build Windows release installer
        shell: pwsh
        env:
          VERSION: ${{ github.event.inputs.version }}
          SKIP_SIGN: ${{ github.event.inputs.skip_sign }}
        run: |
          # Set flags based on inputs
          $params = @{
              Version = $env:VERSION
          }

          if ($env:SKIP_SIGN -eq "true") {
              $params.SkipSign = $true
          }

          # Run build script
          .\scripts\ci\build_windows_release.ps1 @params

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v3
        with:
          name: WireTuner-Windows-Setup.exe
          path: build/release/WireTuner-${{ github.event.inputs.version }}-Windows-Setup.exe
          retention-days: 30

      - name: Upload Windows SHA256 hash
        uses: actions/upload-artifact@v3
        with:
          name: WireTuner-Windows-Setup.sha256
          path: build/release/WireTuner-${{ github.event.inputs.version }}-Windows-Setup.sha256
          retention-days: 30

      - name: Display build summary
        shell: pwsh
        run: |
          $installerPath = "build/release/WireTuner-${{ github.event.inputs.version }}-Windows-Setup.exe"
          $hashPath = "build/release/WireTuner-${{ github.event.inputs.version }}-Windows-Setup.sha256"

          if (Test-Path $installerPath) {
              $size = (Get-Item $installerPath).Length / 1MB
              $hash = Get-Content $hashPath
              Write-Host "✅ Windows installer created successfully"
              Write-Host "   Size: $([Math]::Round($size, 2)) MB"
              Write-Host "   SHA256: $hash"
          } else {
              Write-Host "❌ Windows installer not found"
              exit 1
          }

  # Job 4: Create GitHub Release (if enabled)
  create-release:
    name: Create GitHub Release
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.create_github_release == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download macOS DMG
        uses: actions/download-artifact@v3
        with:
          name: WireTuner-macOS.dmg
          path: ./release-artifacts

      - name: Download macOS SHA256
        uses: actions/download-artifact@v3
        with:
          name: WireTuner-macOS.sha256
          path: ./release-artifacts

      - name: Download Windows installer
        uses: actions/download-artifact@v3
        with:
          name: WireTuner-Windows-Setup.exe
          path: ./release-artifacts

      - name: Download Windows SHA256
        uses: actions/download-artifact@v3
        with:
          name: WireTuner-Windows-Setup.sha256
          path: ./release-artifacts

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Generate SHA256 checksums summary
          MACOS_HASH=$(cat ./release-artifacts/WireTuner-$VERSION-macOS.sha256)
          WINDOWS_HASH=$(cat ./release-artifacts/WireTuner-$VERSION-Windows-Setup.sha256)

          # Create release notes
          cat > release_notes.md <<EOF
          # WireTuner v${VERSION}

          ## Downloads

          - **macOS**: \`WireTuner-${VERSION}-macOS.dmg\`
          - **Windows**: \`WireTuner-${VERSION}-Windows-Setup.exe\`

          ## SHA256 Checksums

          \`\`\`
          macOS:   $MACOS_HASH
          Windows: $WINDOWS_HASH
          \`\`\`

          ## Installation

          ### macOS
          1. Download \`WireTuner-${VERSION}-macOS.dmg\`
          2. Open the DMG file
          3. Drag WireTuner.app to Applications folder
          4. Launch from Applications

          **Note**: macOS 10.15 (Catalina) or later required

          ### Windows
          1. Download \`WireTuner-${VERSION}-Windows-Setup.exe\`
          2. Run the installer
          3. Follow installation wizard
          4. Launch from Start Menu or Desktop shortcut

          **Note**: Windows 10 version 1809 or later required

          ## Verification

          To verify download integrity, compare SHA256 hash:

          ### macOS
          \`\`\`bash
          shasum -a 256 WireTuner-${VERSION}-macOS.dmg
          \`\`\`

          ### Windows (PowerShell)
          \`\`\`powershell
          Get-FileHash WireTuner-${VERSION}-Windows-Setup.exe -Algorithm SHA256
          \`\`\`

          ## Release Metadata

          - **Version**: ${VERSION}
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}

          EOF

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: WireTuner v${{ github.event.inputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.event.inputs.version, '-') }}
          files: |
            ./release-artifacts/WireTuner-${{ github.event.inputs.version }}-macOS.dmg
            ./release-artifacts/WireTuner-${{ github.event.inputs.version }}-macOS.sha256
            ./release-artifacts/WireTuner-${{ github.event.inputs.version }}-Windows-Setup.exe
            ./release-artifacts/WireTuner-${{ github.event.inputs.version }}-Windows-Setup.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Release v${{ github.event.inputs.version }} created successfully!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "View release at:"
          echo "https://github.com/${{ github.repository }}/releases/tag/v${{ github.event.inputs.version }}"
          echo ""

  # Summary job (always runs, reports overall status)
  release-summary:
    name: Release Summary
    needs: [preflight, build-macos, build-windows, create-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Release Pipeline Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Pre-flight:     ${{ needs.preflight.result }}"
          echo "macOS Build:    ${{ needs.build-macos.result }}"
          echo "Windows Build:  ${{ needs.build-windows.result }}"
          echo "GitHub Release: ${{ needs.create-release.result }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          if [ "${{ needs.preflight.result }}" != "success" ] || \
             [ "${{ needs.build-macos.result }}" != "success" ] || \
             [ "${{ needs.build-windows.result }}" != "success" ]; then
            echo "❌ Release pipeline failed"
            exit 1
          fi

          if [ "${{ github.event.inputs.create_github_release }}" == "true" ] && \
             [ "${{ needs.create-release.result }}" != "success" ]; then
            echo "❌ GitHub Release creation failed"
            exit 1
          fi

          echo "✅ Release pipeline completed successfully"
          exit 0
