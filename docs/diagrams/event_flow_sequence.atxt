                                                                                                                                                                                                        Event Sourcing Lifecycle - Complete Flow from User Input to Replay                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                ,-.                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                `-'                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                /|\                                                                        ,--------------------.                                                                                                                                ,-------------.          ,--------------.                                                                                                                                                                         
                                 |                 ,-------------.               ,------------.            |Active Tool         |                         ,-------------.                              ,--------------.             ,----------------.           |Event Handler|          |Document State|                 ,-----------------.                   ,-----------.                 ,----------------.                 ,--------------.           ,---------------.     
                                / \                |Canvas Widget|               |Tool Manager|            |(Pen/Selection/etc.)|                         |Event Sampler|                              |Event Recorder|             |Event Dispatcher|           |Registry     |          |(Immutable)   |                 |SQLite Repository|                   |Event Store|                 |Snapshot Manager|                 |Snapshot Store|           |Canvas Renderer|     
                               User                `------+------'               `------+-----'            `----------+---------'                         `------+------'                              `-------+------'             `--------+-------'           `------+------'          `-------+------'                 `--------+--------'                   `-----+-----'                 `--------+-------'                 `-------+------'           `-------+-------'     
                                 |User interaction        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |(click, drag, keyboard) |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |----------------------->|                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |onPointerDown/Move/Up(point) |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |---------------------------->|                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |onPointerDown/Move/Up(point) |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |---------------------------->|                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        __________________________________________________________________________________________________________________________________________  |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        ! ALT  /  High-frequency input (e.g., mouse drag)               |                                             |                           ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !_____/              |                                          |                                             |                           ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |recordMove(objectId, position, timestamp) |                                             |                           ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |----------------------------------------->|                                             |                           ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                                          |                                             |                           ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                                          |                                             |                           ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         _________________________________________________________________________________          ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         ! ALT  /  Within 50ms of last sample                           |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !_____/          |                                             |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                |----.                                        |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                |    | Buffer movement                        |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                |<---' (throttle to 50ms)                     |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                |                                             |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                |                                             |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                | ,------------------------------!.           |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                | |Prevents event flood.         |_\          |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                | |Buffers intermediate positions  |          |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                | |until 50ms threshold reached.   |          |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         ! [50ms elapsed since last sample]                             |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                |recordEvent(MoveAnchorEvent/MoveObjectEvent) |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                |-------------------------------------------->|                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                |                                             |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                | ,------------------------------!.           |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                | |Sampling reduces 2-second drag|_\          |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                | |from ~200 events to ~40 events  |          |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !                | |(5x storage reduction)          |          |                 !         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                         !~~~~~~~~~~~~~~~~~~`--------------------------------'~~~~~~~~~~~~~~~~~~~~~~~~~~~~!         ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        ! [Discrete input (e.g., single click)]                         |                                             |                           ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |                   recordEvent(CreatePathEvent/AddAnchorEvent/etc.)                     |                           ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !                    |--------------------------------------------------------------------------------------->|                           ! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |        !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~! |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |----.                        |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |    | Assign sequence number |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |<---' (monotonic counter)    |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |      dispatch(event)        |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |---------------------------->|                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |lookupHandler(event.type) |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |------------------------->|                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |    Handler function      |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |<- - - - - - - - - - - - -|                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |          handler(currentDocument, event)           |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |--------------------------------------------------->|                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | ,----------------------------------------!.                        |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |All domain models are immutable.        |_\                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |Event application is pure function:       |                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |(State, Event) â†’ NewState                 |                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |                                          |                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |Example: AddAnchorEvent                   |                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |1. Get path by ID from current doc        |                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |2. Create new Path with added anchor      |                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |3. Return new Document with updated path  |                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |                                          |                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | |No in-place mutations.                    |                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         | `------------------------------------------'                       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |----.                            |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |    | Create new immutable state |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |<---'                            |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                New Document state                  |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |<- - - - - - - - - - - - - - - - - - - - - - - - - -|                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | Event applied successfully  |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |<- - - - - - - - - - - - - - |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                  insertEvent(event)                |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |------------------------------------------------------------------------------------------------------------------->|                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |----.                             |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |    | Serialize event to JSON     |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |<---'                             |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |  INSERT INTO events              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |  (event_sequence, event_type,    |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |  event_payload, created_at)      |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |--------------------------------->|                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |----.                           |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |    | SQLite transaction        |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |<---' (WAL mode for durability) |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
          _____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________                 |                                 |                          |             
          ! ALT  /  Insert successful                     |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |               !                |                                 |                          |             
          !_____/                |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |             Success              |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |<- - - - - - - - - - - - - - - - -|               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |             Event persisted (sequence #N)          |                                 |                                  |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -|                                  |               !                |                                 |                          |             
          !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!                |                                 |                          |             
          ! [Disk full error]    |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |        SQLITE_FULL error         |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |<- - - - - - - - - - - - - - - - -|               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |----.                             |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |    | Retry with backoff          |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |<---' (50ms, 100ms, 200ms)        |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |               !                |                                 |                          |             
          !                      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |               !                |                                 |                          |             
          !         ___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________                |               !                |                                 |                          |             
          !         ! ALT  /  Retry successful            |                             |                             |                                          |                                             |                             |                          |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !_____/      |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                             |                                          |                                             |                             |                    Event persisted                 |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                             |                                          |                                             |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -|                  !               |               !                |                                 |                          |             
          !         !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!               |               !                |                                 |                          |             
          !         ! [All retries failed]                |                             |                             |                                          |                                             |                             |                          |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                             |                                          |                                             |                             |                   Error: Disk full                 |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                             |                                          |                                             |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -|                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                  Surface error:                                        |                                             |                             |                          |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                  "Cannot save - disk full"                             |                                             |                             |                          |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !            |<----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|                             |                          |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                             |                                          |                                             | ,----------------------------------!.                  |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                             |                                          |                                             | |Enter read-only mode,             |_\                 |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !            |                        |                             |                             |                                          |                                             | |allow export to alternate location  |                 |                         |                                 |                  !               |               !                |                                 |                          |             
          !         !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~`------------------------------------'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!               |               !                |                                 |                          |             
          !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |notifyListeners()                         |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |(Flutter Provider pattern)                |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |<---------------------------------------------------------------------------------------------------------------------------------------------------|                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |   build() â†’ paint(NewDocument)                     |                                 |                                  |                                |                                 |                          |             
                                 |                        |--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------->|             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                        Display updated canvas          |                         |                                 |                                  |                                |                                 |                          |             
                                 |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           _________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________             
                                 |                        |                             |                             |                                          |                           ! ALT  /  Event count milestone (1000, 2000, 3000...)                      |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !_____/           |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                    onEventMilestone(sequence: N)          |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------->|                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |      getCurrentDocument()        |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |<----------------------------------------------------------------------------------------------------|                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |     Current document state       |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         | - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - ->|                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |----.                            |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |    | Serialize document to JSON |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |<---'                            |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |----.                            |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |    | Compress with gzip         |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |<---' (~10:1 compression)        |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |          createSnapshot(eventSequence, compressedBlob)            |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |<------------------------------------------------------------------|                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  INSERT INTO snapshots            |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  (event_sequence, snapshot_data)  |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |---------------------------------------------------------------------------------------------------->|                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |                                  |                                |                                 |                          |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              ___________________________________________________________________________________________________________________________________________         |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              ! ALT  /  Snapshot creation successful                |                                |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !_____/            |                                  |                                |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |           Success              |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                         Snapshot created                          |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  | - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - ->|                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                | ,------------------------------!.                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                | |Latency budget: < 25ms        |_\                !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                | |Snapshot size: ~10-50KB         |                !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                | |Keeps 10 most recent snapshots  |                !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              ! [Disk full / Serialization error]                   |                                |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |            Error               |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                         Snapshot failed                           |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  | - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - ->|                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                |----.                            |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                |    | Log warning, skip snapshot |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                |<---'                            |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                |                                 |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                | ,---------------------------!.  |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                | |Snapshots are optimization,|_\ |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                | |not critical path.           | |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !                  |                                  |                                | |Continue event recording.    | |                 !        |!            
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |              !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~`-----------------------------'~~~~~~~~~~~~~~~~~~~!        |!            
                                 |                        |                             |                             |                                          |                           !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!            
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |              ======================                    |                         |                                 |                                  |                                |                                 |                          |             
=============================================================================================================================================================================================================================== Document Load Flow ================================================================================================================================================================================================================================
                                 |                        |                             |                             |                                          |                                             |              ======================                    |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 | Open .wiretuner file   |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |----------------------->|                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                  loadDocument(filePath)     |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------>|                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |   SELECT MAX(event_sequence)     |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |   FROM events                    |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |--------------------------------->|                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |         maxSequence = N          |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |<- - - - - - - - - - - - - - - - -|                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                SELECT snapshot_data, event_sequence                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                FROM snapshots                     |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                WHERE event_sequence <= N          |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                ORDER BY event_sequence DESC       |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                LIMIT 1                            |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |---------------------------------------------------------------------------------------------------->|                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |   Snapshot at sequence M,      |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |   compressed BLOB              |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |----.                             |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |    | Decompress snapshot         |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |<---' (gzip â†’ JSON)               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |----.                             |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |    | Deserialize JSON â†’ Document |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |<---'                             |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |   SELECT * FROM events           |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |   WHERE event_sequence > M       |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |   ORDER BY event_sequence ASC    |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |--------------------------------->|                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |       Events M+1 to N            |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |       (up to 1000 events)        |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |<- - - - - - - - - - - - - - - - -|                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          _____________________________________________________________________________________________________________________________                |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          ! LOOP  /  For each event (M+1 to N)          |                         |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !______/           |                          |                         |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |                          |        dispatch(event)  |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |<-------------------------------------------------------------------------------------|                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |                          |                         |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |lookupHandler(event.type) |                         |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |------------------------->|                         |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |                          |                         |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |             handler(document, event)               |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |--------------------------------------------------->|                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |                          |                         |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |                          |                         |----.                            |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |                          |                         |    | Apply event â†’ New state    |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |                          |                         |<---'                            |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |                          |                         |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |                 Updated document                   |                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !                  |<- - - - - - - - - - - - - - - - - - - - - - - - - -|                                 |                  !               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |          !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 | ,-----------------------------------------!.                      |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 | |Latency budget: < 200ms                  |_\                     |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 | |                                           |                     |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 | |Typical: Snapshot + 100-500 events         |                     |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 | |Worst case: 1000 events between snapshots  |                     |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 | |                                           |                     |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 | |Optimization: Viewport culling,            |                     |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 | |lazy rendering during replay               |                     |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 | `-------------------------------------------'                     |                                 |                          |             
                                 |                        |                             |                             |                                          |                   Final document state      |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |          paint(Document) |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------->|             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                       Display loaded document          |                         |                                 |                                  |                                |                                 |                          |             
                                 |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |            ==========================                  |                         |                                 |                                  |                                |                                 |                          |             
============================================================================================================================================================================================================================= Undo Operation (Cmd+Z) ==============================================================================================================================================================================================================================
                                 |                        |                             |                             |                                          |                                             |            ==========================                  |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |  Press Cmd+Z (Undo)    |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |----------------------->|                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |          undo()                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |--------------------------------------------------------------------------------------------------------------------------------------------------->|                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |----.                        |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |    | currentSequence = N    |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |<---' targetSequence = N - 1 |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |           SELECT MAX(event_sequence)                               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |           FROM snapshots        |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |           WHERE event_sequence <= (N-1)                            |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------->|                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |               snapshotSequence = M                                 |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -|                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |             SELECT snapshot_data|                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |             FROM snapshots      |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |             WHERE event_sequence = M                               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------->|                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                   Snapshot BLOB |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -|                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |----.                        |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |    | Deserialize snapshot   |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |<---' â†’ Base Document        |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |    SELECT * FROM events |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |    WHERE event_sequence > M                               |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |    AND event_sequence <= (N-1)                            |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |    ORDER BY event_sequence ASC                            |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |------------------------------------------------------------------------------------------------------------------------------------------------------>|                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |         Events M+1 to N-1                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           ___________________________________________________________________________________________________________________________________________                               |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           ! LOOP  /  For each event (M+1 to N-1)          |                          |                         |                                 |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !______/          |                             |                          |                         |                                 |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !                 |      dispatch(event)        |                          |                         |                                 |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !                 |---------------------------->|                          |                         |                                 |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !                 |                             |                 applyEvent(event)                  |                                 |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !                 |                             |--------------------------------------------------->|                                 |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |                                 |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |----.                            |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |    | Create new immutable state |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !                 |                             |                          |                         |<---'                            |   !                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                           !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!                              |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |setDocument(documentAtN-1,                |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |currentSequence: N-1)                     |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |<---------------------------------------------------------------------------------------------------------------------------------------------------|                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |          paint(Document) |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------->|             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                        Display document with           |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                        last action undone              |                         |                                 |                                  |                                |                                 |                          |             
                                 |<- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | ,-----------------------------------!.                 |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | |Undo/Redo is time travel           |_\                |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | |to specific sequence number.         |                |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | |                                     |                |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | |Redo: Navigate to N+1                |                |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | |                                     |                |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | |Latency budget: < 100ms              |                |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | |(typically < 100 events from cache)  |                |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             | `-------------------------------------'                |                         |                                 |                                  |                                |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |     ,-------------------------------------------------------!.    |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |     |**Error Handling:**                                    |_\   |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |     |- Disk Full: Retry with backoff, enter read-only mode    |   |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |     |- Corruption: Integrity check on startup, validate JSON  |   |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |     |- Missing Events: Detect sequence gaps, surface error    |   |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |     `---------------------------------------------------------'   |                                 |                          |             
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |   ,----------------------------------------------------------!.          
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |   |**Error Handling:**                                       |_\         
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |   |- Snapshot Corruption: Fallback to previous snapshot        |         
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |   |- Decompression Error: Warn user, attempt partial recovery  |         
                                 |                        |                             |                             |                                          |                                             |                             |                          |                         |                                 |                                  |                                |   |- Missing Snapshot: Replay from document start (slower)     |         
                               User                ,------+------.               ,------+-----.            ,----------+---------.                         ,------+------.                              ,-------+------.             ,--------+-------.           ,------+------.          ,-------+------.                 ,--------+--------.                   ,-----+-----.                 ,--------+---`------------------------------------------------------------'---.     
                                ,-.                |Canvas Widget|               |Tool Manager|            |Active Tool         |                         |Event Sampler|                              |Event Recorder|             |Event Dispatcher|           |Event Handler|          |Document State|                 |SQLite Repository|                   |Event Store|                 |Snapshot Manager|                 |Snapshot Store|           |Canvas Renderer|     
                                `-'                `-------------'               `------------'            |(Pen/Selection/etc.)|                         `-------------'                              `--------------'             `----------------'           |Registry     |          |(Immutable)   |                 `-----------------'                   `-----------'                 `----------------'                 `--------------'           `---------------'     
                                /|\                                                                        `--------------------'                                                                                                                                `-------------'          `--------------'                                                                                                                                                                         
                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                / \                                                                                                                                                                                                                                                                                                                                                                                                                                                
