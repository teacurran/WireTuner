<!-- anchor: system-architecture-blueprint -->
# System Architecture Blueprint: WireTuner

**Version:** 1.0
**Date:** 2025-11-10
**Generated By:** Structural_Data_Architect

<!-- anchor: introduction-goals -->
## 1. Introduction & Goals

<!-- anchor: project-vision -->
### 1.1 Project Vision
WireTuner delivers a professional-grade desktop vector drawing studio that unifies precision tooling, multi-artboard orchestration, and complete event-sourced storytelling of every creative gesture.
It fuses the immediacy of a Flutter 3.x Clean Architecture client with durable SQLite-backed histories so designers can replay, audit, and collaborate across time.
The vision extends beyond single documents by enabling artboard-per-window workflows, responsive design exploration, and future multiplayer collaboration without sacrificing offline independence.
Every architectural decision reinforces the promise that the act of drawing is as observable and replayable as the final illustration itself.

### 1.1a Vision Amplifiers
The blueprint elevates anchor visibility customization, advanced typography, and boolean geometry into first-class citizens so the creative process remains flexible across macOS and Windows targets.
It ensures that hybrid file formats (.wiretuner SQLite + JSON snapshot export) provide both high-performance editing and transparent archival interchange for version control ecosystems.
It positions WireTuner as a reference implementation of reproducible creativity where snapshots, events, and metadata remain in lockstep regardless of platform or collaboration state.

<!-- anchor: key-objectives -->
### 1.2 Key Objectives
- Deliver a multi-artboard desktop suite where each artboard runs in its own window yet shares a consistent InteractionEngine, enabling responsive design boards, icon grids, and immersive device templates.
- Maintain exhaustive event capture (operations, object deltas, viewport moves) with configurable sampling so history replay, analytics, and collaboration OT can rely on deterministic logs.
- Guarantee import and export fidelity for SVG, PDF (via SVG conversion), JSON, and AI (PDF-compatible) formats so designers can interoperate with Illustrator, Figma, or scripted pipelines.
- Provide per-artboard viewport, selection, and layer isolation to ensure switching between windows or documents retains the users mental model and eliminates destructive shared state.
- Embed real-time performance metrics (FPS, event counts, snapshot latency) to uphold strict SLAs such as 60 FPS canvas operations for documents with up to 1,000 objects.
- Enforce auto-save plus explicit manual save checkpoints, so zero edits are lost during crashes while designers may tag intentional milestones in the event stream.
- Prepare for multiplayer collaboration by codifying Operational Transform contracts, WebSocket streaming payloads, and GraphQL metadata fetch paths today, preventing rewrites later.
- Surface robust error handling for disk full, corrupted SQLite, unsupported SVG constructs, or migration rollbacks so data integrity is never compromised.
- Preserve platform-native conveniences such as QuickLook thumbnails, Explorer previews, and standard OS dialogs without fragmenting the core Flutter codebase.
- Ensure extensibility through registries (ToolRegistry, OverlayRegistry, ImportExportService adapters) so future plugins, conversion targets, or visualization overlays attach without Layer violations.
- Uphold accessibility and localization commitments, including WCAG-compliant anchor color palettes, screen-reader-friendly toasts, and internationalized status messaging.
- Align telemetry, feature flagging, and observability instrumentation with LaunchDarkly, Prometheus, and OpenTelemetry expectations to keep releases diagnosable post-deployment.

<!-- anchor: scope -->
### 1.3 Scope
This blueprint covers the static composition of the WireTuner ecosystem, spanning the Flutter desktop monolith, the embedded SQLite persistence fabric, Dart Frog collaboration and metadata services, and auxiliary workers such as SVG-to-PDF converters.
It defines the Clean Architecture layers inside the desktop app, the separation of NavigatorService, RenderingPipeline, InteractionEngine, EventStoreService, and BackgroundWorkerPool, plus the data contracts binding them.
It includes the multi-artboard Navigator, artboard lifecycle events, window choreography, and the feature flag plus configuration surfaces that gate incremental capabilities.
It delineates the backend containersCollaboration Gateway, Sync API, Telemetry Service, Redis Pub/Sub, PostgreSQL, object storage, and observability stacksrequired for multiplayer, telemetry, and conversion jobs.
Out of scope are runtime behaviors like gesture sequences or latency tuning algorithms (owned by Behavior_Architect) and operational playbooks (owned by Ops_Docs), though interfaces to those concerns are enumerated here.

<!-- anchor: key-assumptions -->
### 1.4 Key Assumptions
- Users run on macOS 10.15+ or Windows 10+ with ≥4 GB RAM, and they interact via mouse or trackpad; touch inputs and plugins remain future enhancements.
- Clean Architecture layering is inviolable: Presentation  Application  Domain  Infrastructure, with Freezed models ensuring immutability and Provider/ChangeNotifier wiring dependencies.
- Event sourcing stores every change without retention pruning; snapshots (500-event, 10-minute, manual save triggers) keep load times acceptable, and performance budgets are actively monitored.
- SQLite stays in WAL mode with fsync for durability; PostgreSQL plus Redis and S3 analogues back collaboration, queueing, and archival pipelines as the blueprint designates.
- Feature flags via LaunchDarkly/Flagsmith govern incremental rollouts, and observability is standardized through Prometheus metrics, OpenTelemetry tracing, and structured JSON logs.
- Operational Transform is the conflict resolution mechanism for multiplayer editing, with concurrency capped (default ≤10 editors per document) and fallback paths documented for offline sessions.
- PDF conversion defaults to resvg-based workers for vector fidelity, though alternative backends must be drop-in adapters with identical contracts.
- Undo history defaults to 100 operations yet can become unlimited with explicit confirmation; warning toasts appear when memory budgets exceed thresholds defined by ConfigurationService.
- Replay checkpoints are lazily generated per 1,000 events and evicted when memory exceeds ~100 MB, ensuring timeline scrubbing respects resource constraints.
- Telemetry opt-out is always honored; when disabled, logs remain local and network calls are suppressed, requiring manual export if diagnostics are needed.

<!-- anchor: architectural-drivers -->
## 2. Architectural Drivers

<!-- anchor: functional-requirements-summary -->
### 2.1 Functional Requirements Summary
WireTuner must support pen, shape, selection, and direct selection tools with high-frequency sampling, anchor-state visualization, grid snapping, multi-selection gestures, and arrow key nudging behaviors defined in FR-001 through FR-050.
It needs comprehensive document management: multi-artboard creation, duplication, deletion safety, artboard navigator auto-launch, per-artboard layers, background colors, export scopes, and per-document metadata persistence.
History obligations include event sampling, operation boundary detection (200 ms), undo/redo stack governance, snapshot production, and timeline replay with checkpoint caching.
Import/export pipelines must translate SVG (Tier 1 & 2), PDF via SVG conversion, AI (PDF compatible), JSON snapshot exports, and per-artboard exports while surfacing compatibility warnings.
Viewport and navigator behaviors enforce per-artboard selection isolation, viewport persistence, thumbnail refresh cadences, and artboard window lifecycle rules.
Platform integration drivers demand QuickLook/Explorer thumbnails, OS-native dialogs, file associations, and future macOS/Windows-specific enhancements.
Collaboration readiness requires GraphQL APIs, WebSocket streaming, OT conflict handling, presence indicators, and security boundaries (JWT auth, TLS 1.3, keychain storage).
Error-handling flows must address disk full events, corrupted files with recovery attempts, incompatible file versions, and import/export failures with actionable remediation messaging.

<!-- anchor: non-functional-requirements -->
### 2.2 Non-Functional Requirements (NFRs)
- **Performance:** Load documents ≤10 K events under 100 ms, replay ≥5 K events/sec, maintain 60 FPS canvas and 30 FPS navigator thumbnails, keep snapshot creation asynchronous with zero UI hitches, and ensure cursor updates in <0.2 ms.
- **Reliability:** Auto-save after every operation, crash recovery via event replays, SQLite integrity checks, migration backups, OT sequencing resilience, and deterministic replay hash validation guard against inconsistency.
- **Scalability:** Support up to 1,000 artboards, 100,000 events per document, and ≥20 simultaneous artboard windows per session, while backend services autoscale across Redis clusters and Kubernetes pods.
- **Maintainability:** Enforce Freezed immutability, Clean Architecture boundaries, ≥80% test coverage for domain and event sourcing logic, melos-managed workspaces, and ADR-backed deviations.
- **Security & Compliance:** TLS 1.3 end-to-end, JWT lifetimes (15 minutes), secure storage of refresh tokens, file path canonicalization, GDPR-compliant telemetry opt-out, SOC 2-friendly audit trails, and secrets stored in AWS Secrets Manager.
- **Observability:** Structured logging, Prometheus metrics, OpenTelemetry traces from InteractionEngine through backend services, alerting on FPS drops, snapshot deferments, or OT queue saturation.
- **Portability:** Byte-identical .wiretuner files on macOS and Windows, Flutter-based code-sharing, containerized backend deployments, and platform-specific integrations encapsulated in dedicated adapters.
- **Usability:** Tool cursor feedback in <1 frame, informative toasts for anchor visibility modes or zoom suggestions, localized strings, and error dialogs with remediation instructions validated via user studies.

<!-- anchor: constraints-preferences -->
### 2.3 Constraints & Preferences
- Clean layered monolith in Flutter for the desktop client; backend services limited to Dart Frog or approved Node.js/TypeScript frameworks, with Rust FFI restricted to SVG/PDF conversions.
- Persistence stack predetermined: SQLite for local editing, PostgreSQL for collaboration metadata, Redis for presence/pub-sub, S3-compatible object storage for artifacts, plus AWS as the reference cloud.
- Messaging: WebSockets for event streaming, GraphQL for metadata, Redis Pub/Sub/SQS for background jobs, LaunchDarkly/Flagsmith for feature control, OpenTelemetry for tracing.
- Build & packaging: Flutter build pipelines, Dockerized backend workloads, Kubernetes orchestration, notarized DMG and MSI installers bundling thumbnail providers.
- Observability & feature flags mandated; no new third-party services may be added without ADR approval.
- Tooling frameworks (ToolRegistry, OverlayRegistry, ImportExport adapters, BackgroundWorkerPool) must remain open for future plugin ecosystems even if plugins are out of scope now.
- All configuration parameters route through ConfigurationService, ensuring remote overrides and migrations apply uniformly across documents.
- Telemetry must remain aggregate-first, anonymized, and respect opt-out states; manual export tools cover support scenarios.

<!-- anchor: proposed-architecture -->
## 3. Proposed Architecture (Structural View)

<!-- anchor: architectural-style -->
### 3.1 Architectural Style
WireTuner adheres to the Clean Architecture onion model mandated by the foundation: Presentation  Application  Domain  Infrastructure within the Flutter desktop monolith, and a service-oriented backend composed of GraphQL + WebSocket microservices containerized on Kubernetes.
This separation ensures UI widgets never mutate domain state directly, InteractionEngine mediates commands, Domain models remain immutable Freezed data, and Infrastructure adapts to SQLite, Redis, PostgreSQL, and resvg workers without bleeding into higher layers.

<!-- anchor: technology-stack-summary -->
### 3.2 Technology Stack Summary
| Layer / Concern | Technology | Rationale |
| --- | --- | --- |
| Desktop UI & Rendering | Flutter 3.x, CustomPainter, Provider/ChangeNotifier | Cross-platform desktop delivery with GPU-accelerated rendering and DI-friendly state propagation |
| Domain Modeling | Dart 3.x, Freezed, json_serializable | Immutable value objects, deterministic serialization, and shared DTOs across client/server |
| Persistence (Client) | SQLite 3.x (WAL mode via sqflite) | Durable event log + snapshots with transactional guarantees and fast local queries |
| Background Processing | Flutter compute() isolates, BackgroundWorkerPool, resvg (Rust FFI) | Non-blocking snapshot creation, SVG-to-PDF conversion, AI import parsing |
| Backend APIs | Dart Frog (preferred) or Node.js (NestJS) | Shared language with client, type-safe DTO reuse, WebSocket + GraphQL support |
| Databases (Server) | PostgreSQL 14+, Redis Cluster, S3-compatible object storage | Collaboration metadata, OT sequencing, pub/sub fan-out, artifact retention |
| Messaging & Flags | Redis Pub/Sub, AWS SQS, LaunchDarkly/Flagsmith | Real-time collaboration, job dispatch, controlled feature rollout |
| Observability | OpenTelemetry, Prometheus, structured JSON logging, CloudWatch/Loki dashboards | Unified tracing, metrics, and alerting pipelines |
| Packaging & Distribution | Docker, Kubernetes (EKS), macOS DMG, Windows MSI, QuickLook/Explorer extensions | Repeatable deployment, auto-scaling services, platform-native installers |
| Security | TLS 1.3, JWT auth, OS keychain storage, AWS Secrets Manager | Secure channels, credential protection, compliance readiness |

<!-- anchor: system-context-diagram -->
### 3.3 System Context Diagram (C4 Level 1)
**Description:** The context diagram situates WireTuner Desktop Application within its ecosystem of designers, reviewers, OS services, collaboration infrastructure, feature flag services, telemetry, and conversion workers while showing the Clean Architecture client as the central system boundary.

~~~plantuml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
SHOW_PERSON_OUTLINE()
AddElementTag("SaaS", $bgColor="#e0f7fa", $fontColor="#004d40")
AddElementTag("Desktop", $bgColor="#ede7f6", $fontColor="#311b92")
Person(proDesigner, "Pro Designer", "Creates production-grade illustrations and responsive UI artboards")
Person(illustratorLead, "Illustrator Lead", "Curates files, reviews timelines, and mandates fidelity with Adobe files")
Person(qaSpecialist, "QA Specialist", "Validates performance budgets, telemetry, and regression coverage")
Person(supportEngineer, "Support Engineer", "Assists with troubleshooting, crash recovery, and telemetry exports")
System_Boundary(wireSuite, "WireTuner Desktop Suite") {
  System(wireDesktop, "WireTuner Desktop Application", "Flutter 3.x Clean Architecture monolith running on macOS/Windows", $tags="Desktop")
}
System_Ext(collabGateway, "Collaboration Gateway", "Dart Frog WebSocket + GraphQL service for OT sequencing", $tags="SaaS")
System_Ext(syncAPI, "Sync API", "GraphQL/REST metadata and snapshot exchange service", $tags="SaaS")
System_Ext(telemetryService, "Telemetry Service", "Prometheus/OpenTelemetry ingest stack", $tags="SaaS")
System_Ext(featureFlagSvc, "Feature Flag Platform", "LaunchDarkly/Flagsmith configuration and rollout control", $tags="SaaS")
System_Ext(osFileSystem, "OS File System", "macOS Finder / Windows Explorer for .wiretuner file access")
System_Ext(svgLibrary, "SVG Import Sources", "External SVG/AI/PDF documents from third-party tools")
System_Ext(pdfService, "SVG-to-PDF Worker Farm", "resvg-powered container workers converting SVG into PDF artifacts")
System_Ext(identityProvider, "Identity Provider", "Auth service issuing JWTs", $tags="SaaS")
System_Ext(crashPortal, "Crash Reporting Portal", "Ops dashboard to inspect client logs and dumps")
System_Ext(macQuickLook, "macOS QuickLook Extension", "Finder preview generator for .wiretuner files")
System_Ext(winExplorerHandler, "Windows Explorer Handler", "Preview/thumbnail handler for Windows users")
System_Ext(redisBackplane, "Redis Cluster", "Pub/Sub fan-out for collaboration and job dispatch", $tags="SaaS")
System_Ext(objectStorage, "Object Storage", "S3-compatible storage for exports, backups, thumbnails", $tags="SaaS")
Rel(proDesigner, wireDesktop, "Creates/edits documents via pen, shape, typography, boolean tools")
Rel(illustratorLead, wireDesktop, "Reviews artboards, triggers exports, inspects history timelines")
Rel(qaSpecialist, wireDesktop, "Runs regression workflows, monitors FPS and event replay targets")
Rel(supportEngineer, wireDesktop, "Guides recovery, collects logs, ensures migrations succeed")
Rel(wireDesktop, collabGateway, "Streams OT events, receives remote edits", "WebSocket (TLS 1.3)")
Rel(wireDesktop, syncAPI, "Loads snapshots, metadata, document lists", "GraphQL over HTTPS")
Rel(wireDesktop, telemetryService, "Emits metrics, logs, traces", "OpenTelemetry gRPC/HTTP")
Rel(wireDesktop, featureFlagSvc, "Evaluates rollout flags", "HTTPS polling + streaming")
Rel(wireDesktop, osFileSystem, "Reads/writes .wiretuner SQLite bundles, JSON exports", "POSIX/Win32 I/O")
Rel(wireDesktop, svgLibrary, "Imports SVG/AI/PDF files", "File open dialogs")
Rel(wireDesktop, pdfService, "Queues SVG payloads for PDF conversion", "Background worker queue")
Rel(wireDesktop, identityProvider, "Authenticates, refreshes JWTs", "OAuth 2.0 / OIDC")
Rel(collabGateway, redisBackplane, "Broadcasts events", "Pub/Sub")
Rel(syncAPI, objectStorage, "Stores snapshots/exports", "S3 API")
Rel(telemetryService, crashPortal, "Surfaces incidents", "Dashboards + alerts")
Rel(macQuickLook, wireDesktop, "Uses RenderingPipeline to render thumbnails", "Plugin bundle")
Rel(winExplorerHandler, wireDesktop, "Consumes cached thumbnails", "Shell extension")
Rel_L(wireDesktop, pdfService, "Streams exports", "SQS job descriptors")
Rel_L(collabGateway, identityProvider, "Validates tokens", "JWT introspection")
Rel(qaSpecialist, telemetryService, "Monitors metrics", "Dashboards")
Rel(proDesigner, macQuickLook, "Previews art without launching app", "Finder preview")
Rel(illustratorLead, winExplorerHandler, "Previews assets", "Explorer shell")
Rel(supportEngineer, crashPortal, "Triages incidents", "Web UI")
Rel(svgLibrary, wireDesktop, "Provides input artifacts", "Import pipeline")
Rel(objectStorage, supportEngineer, "Delivers export artifacts", "Signed URLs")
Rel_L(telemetryService, redisBackplane, "Publishes anomaly alerts", "Event bus")
Rel_L(featureFlagSvc, wireDesktop, "Pushes flag updates", "Streaming client")
Rel_L(syncAPI, telemetryService, "Reports API health", "Metrics")
Rel_L(pdfService, objectStorage, "Uploads PDF results", "S3 API")
Rel_L(redisBackplane, collabGateway, "Fan-out presence", "Pub/Sub channels")
Lay_R(proDesigner, illustratorLead)
Lay_D(qaSpecialist, supportEngineer)
Lay_L(svgLibrary, pdfService)
Lay_D(collabGateway, redisBackplane)
Lay_D(syncAPI, objectStorage)
Lay_L(macQuickLook, winExplorerHandler)
@enduml
~~~

<!-- anchor: container-diagram -->
### 3.4 Container Diagram (C4 Level 2)
**Description:** The container view decomposes WireTuner into deployable/run-time units, including the Flutter desktop application, embedded SQLite, BackgroundWorkerPool, Collaboration Gateway, Sync API, Telemetry service, Feature Flag service, Redis, PostgreSQL, Conversion Workers, Observability stack, and platform-specific handlers.

~~~plantuml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
SHOW_LEGEND()
AddElementTag("Runtime", $bgColor="#fff3e0", $fontColor="#e65100")
AddElementTag("Service", $bgColor="#e8f5e9", $fontColor="#1b5e20")
AddElementTag("Store", $bgColor="#e3f2fd", $fontColor="#0d47a1")
Person(designerPersona, "Designer", "Primary creative user")
Person(opsPersona, "Ops_Docs Engineer", "Manages deployments and installers")
System_Boundary(desktopBoundary, "WireTuner Desktop Runtime") {
  Container(wireDesktopApp, "WireTuner Desktop Application", "Flutter 3.x", "Presentation/Application/Domain/Infrastructure Clean layers", $tags="Runtime")
  ContainerDb(sqliteStore, "Embedded Event Store", "SQLite 3.x (WAL)", "Events, snapshots, metadata", $tags="Store")
  Container(backgroundWorkers, "BackgroundWorkerPool", "Flutter isolates + Rust resvg", "Snapshots, SVG-to-PDF, AI import", $tags="Runtime")
  Container(quickLookExt, "QuickLook Extension", "macOS plugin", "Finder thumbnails", $tags="Runtime")
  Container(explorerHandler, "Explorer Handler", "Windows shell extension", "Explorer thumbnails", $tags="Runtime")
}
System_Boundary(serverBoundary, "WireTuner Cloud Services") {
  Container(collabGatewaySvc, "Collaboration Gateway", "Dart Frog", "WebSocket OT sequencing, presence", $tags="Service")
  Container(syncAPISvc, "Sync API", "Dart Frog GraphQL/REST", "Document metadata, snapshots, settings", $tags="Service")
  Container(telemetrySvc, "Telemetry Collector", "Prometheus + OpenTelemetry", "Metrics/logs/traces", $tags="Service")
  Container(featureFlagSvc, "Feature Flag Service", "LaunchDarkly/Flagsmith", "Feature toggles, config", $tags="Service")
  Container(redisCluster, "Redis Pub/Sub", "Redis Cluster", "Presence channels, fan-out", $tags="Store")
  Container(postgresDb, "Collaboration Metadata DB", "PostgreSQL 14+", "Documents, sessions, settings", $tags="Store")
  Container(objectStore, "Artifact Storage", "S3-compatible", "Exports, snapshots, thumbnails", $tags="Store")
  Container(conversionWorkers, "Conversion Worker Fleet", "Rust resvg containers", "SVG-to-PDF, AI ingest", $tags="Service")
  Container(observabilityStack, "Observability Stack", "Grafana/Loki/CloudWatch", "Dashboards, alerts, log archives", $tags="Service")
  Container(installerPipelines, "Installer Pipelines", "GitHub Actions + Notarization", "DMG/MSI packaging", $tags="Service")
}
Rel(designerPersona, wireDesktopApp, "Creates artboards, triggers exports, replays history")
Rel(wireDesktopApp, sqliteStore, "Persists events, snapshots", "sqflite")
Rel(wireDesktopApp, backgroundWorkers, "Dispatches snapshot/PDF/import jobs", "Isolate messages + FFI")
Rel(wireDesktopApp, collabGatewaySvc, "Streams OT events", "WSS")
Rel(wireDesktopApp, syncAPISvc, "Queries metadata, uploads snapshots", "GraphQL")
Rel(wireDesktopApp, telemetrySvc, "Sends metrics/logs", "OTLP/HTTP")
Rel(wireDesktopApp, featureFlagSvc, "Evaluates flags", "HTTPS streaming")
Rel(wireDesktopApp, quickLookExt, "Shares renderer pipelines", "Shared library")
Rel(wireDesktopApp, explorerHandler, "Provides cached thumbnails", "Shared cache")
Rel(backgroundWorkers, objectStore, "Uploads conversion outputs", "S3 API")
Rel(backgroundWorkers, conversionWorkers, "Queues complex conversions", "Redis Streams / SQS")
Rel(collabGatewaySvc, redisCluster, "Fan-out real-time events", "Pub/Sub")
Rel(collabGatewaySvc, postgresDb, "Stores session metadata", "SQL over TLS")
Rel(syncAPISvc, postgresDb, "Reads/writes document metadata", "SQL")
Rel(syncAPISvc, objectStore, "Stores large snapshots", "S3 API")
Rel(syncAPISvc, telemetrySvc, "Reports API KPIs", "Metrics")
Rel(conversionWorkers, objectStore, "Publishes exported PDFs", "S3 API")
Rel(conversionWorkers, telemetrySvc, "Emits conversion metrics", "OTLP")
Rel(featureFlagSvc, postgresDb, "Stores overrides", "Secure API")
Rel(redisCluster, telemetrySvc, "Streams health metrics", "Exporters")
Rel(observabilityStack, opsPersona, "Provides dashboards/alerts")
Rel(installerPipelines, opsPersona, "Provides signed installers")
Rel(installerPipelines, objectStore, "Publishes installer artifacts", "S3")
Rel(wireDesktopApp, installerPipelines, "Consumes updates", "Download channel")
Rel(telemetrySvc, observabilityStack, "Feeds dashboards", "Metrics/logs")
Rel_L(featureFlagSvc, wireDesktopApp, "Pushes flag updates", "Streaming SDK")
Rel_L(syncAPISvc, collabGatewaySvc, "Shares document metadata", "gRPC internal")
Rel_L(redisCluster, conversionWorkers, "Dispatches queued exports", "Streams")
Rel_L(postgresDb, observabilityStack, "Provides query stats", "Metrics exporters")
Rel_L(objectStore, observabilityStack, "Storage metrics", "CloudWatch exporters")
Rel_L(backgroundWorkers, telemetrySvc, "Snapshot/PDF duration metrics", "OTLP")
Rel_L(wireDesktopApp, telemetrySvc, "Crash dumps", "HTTPS upload")
Rel_L(designerPersona, quickLookExt, "Finder previews", "macOS QuickLook")
Rel_L(designerPersona, explorerHandler, "Explorer thumbnails", "COM shell")
Rel_L(opsPersona, syncAPISvc, "Manages document lifecycle via admin tools", "GraphQL admin")
Rel_L(opsPersona, collabGatewaySvc, "Monitors sessions", "Admin console")
@enduml
~~~

<!-- anchor: component-diagram -->
### 3.5 Component Diagram (C4 Level 3 - WireTuner Desktop Application)
**Description:** The component view dissects the WireTuner Desktop Application container into clean-layered modules such as DesktopShell, NavigatorService, ToolingFramework, InteractionEngine, RenderingPipeline, EventStoreServiceAdapter, SnapshotManager, ReplayService, SettingsService, FeatureFlagClientAdapter, ImportExportService, CollaborationClient, TelemetryClient, BackgroundWorkerBridge, and SecurityGatewayAdapter.

~~~plantuml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
AddElementTag("AppLayer", $bgColor="#fffde7", $fontColor="#f57f17")
AddElementTag("Domain", $bgColor="#fce4ec", $fontColor="#880e4f")
AddElementTag("Infra", $bgColor="#e3f2fd", $fontColor="#0d47a1")
Container_Boundary(desktopApp, "WireTuner Desktop Application") {
  Component(desktopShell, "DesktopShell", "Presentation", "Window chrome, menu bars, shortcut routing", $tags="AppLayer")
  Component(navigatorService, "NavigatorService", "Presentation", "Artboard tabs, thumbnails, context menus", $tags="AppLayer")
  Component(toolbarService, "ToolbarService", "Presentation", "Tool activation, anchor visibility toggle, metrics overlay", $tags="AppLayer")
  Component(toolingFramework, "ToolingFramework", "Application", "Tool lifecycle management, cursor services, hit testing", $tags="AppLayer")
  Component(interactionEngine, "InteractionEngine", "Application", "Command orchestration, operation boundaries, grid snapping", $tags="AppLayer")
  Component(renderingPipeline, "RenderingPipeline", "Application", "CustomPainter stack, overlays, GPU fallback", $tags="AppLayer")
  Component(eventStoreAdapter, "EventStoreServiceAdapter", "Infrastructure", "SQLite persistence via sqflite", $tags="Infra")
  Component(snapshotManager, "SnapshotManager", "Application", "Background isolate snapshots, compression, memory checks", $tags="AppLayer")
  Component(replayService, "ReplayService", "Application", "Checkpoint generation, timeline scrubbing, hash validation", $tags="AppLayer")
  Component(importExportService, "ImportExportService", "Application", "SVG/AI import, SVG/PDF/JSON export", $tags="AppLayer")
  Component(collaborationClient, "CollaborationClient", "Infrastructure", "WebSocket + GraphQL integration, OT transforms", $tags="Infra")
  Component(settingsService, "SettingsService", "Application", "User/global preferences, configuration governance", $tags="AppLayer")
  Component(featureFlagAdapter, "FeatureFlagClientAdapter", "Infrastructure", "LaunchDarkly/Flagsmith evaluation", $tags="Infra")
  Component(telemetryClient, "TelemetryClient", "Infrastructure", "Metrics/logging/trace emission", $tags="Infra")
  Component(backgroundWorkerBridge, "BackgroundWorkerBridge", "Infrastructure", "Isolate dispatch, Rust FFI bridges", $tags="Infra")
  Component(securityGateway, "SecurityGatewayAdapter", "Infrastructure", "JWT handling, keychain storage, path validation", $tags="Infra")
  Component(domainModels, "Domain Models", "Domain", "Freezed immutable Document/Artboard/Layer/Vector objects", $tags="Domain")
}
Rel(desktopShell, navigatorService, "Opens artboard windows, routes focus events")
Rel(desktopShell, toolbarService, "Updates tool states, anchor visibility, status toasts")
Rel(navigatorService, renderingPipeline, "Requests thumbnails via offscreen render targets")
Rel(toolbarService, toolingFramework, "Activates tools, updates cursors")
Rel(toolingFramework, interactionEngine, "Translates pointer/key input into commands")
Rel(interactionEngine, domainModels, "Creates immutable diffs per command")
Rel(interactionEngine, eventStoreAdapter, "Persists events, loads snapshots")
Rel(interactionEngine, snapshotManager, "Signals operation boundaries for snapshot checks")
Rel(interactionEngine, replayService, "Requests timeline playback state")
Rel(interactionEngine, renderingPipeline, "Notifies new document state for redraw")
Rel(renderingPipeline, domainModels, "Reads objects for painting")
Rel(renderingPipeline, telemetryClient, "Reports FPS, overlay timings")
Rel(snapshotManager, eventStoreAdapter, "Reads state, writes compressed snapshots")
Rel(snapshotManager, backgroundWorkerBridge, "Executes compute() isolates for serialization")
Rel(replayService, eventStoreAdapter, "Streams events for targeted replay")
Rel(replayService, navigatorService, "Feeds timeline thumbnails")
Rel(importExportService, backgroundWorkerBridge, "Delegates heavy conversions to workers")
Rel(importExportService, eventStoreAdapter, "Reads state for exports, writes import events")
Rel(importExportService, securityGateway, "Validates file paths and signatures")
Rel(collaborationClient, interactionEngine, "Injects remote OT operations, publishes locals")
Rel(collaborationClient, securityGateway, "Refreshes tokens, handles auth headers")
Rel(settingsService, toolbarService, "Applies anchor visibility defaults, sampling presets")
Rel(settingsService, interactionEngine, "Delivers grid/snapping/nudge configs")
Rel(featureFlagAdapter, toolbarService, "Enables staged features (e.g., typography beta)")
Rel(featureFlagAdapter, interactionEngine, "Toggles experimental behaviors")
Rel(telemetryClient, collaborationClient, "Shares network health metrics")
Rel(telemetryClient, settingsService, "Honors telemetry opt-out state")
Rel(backgroundWorkerBridge, telemetryClient, "Reports job durations, memory usage")
Rel(securityGateway, eventStoreAdapter, "Guards file paths, encryption keys")
Rel(securityGateway, importExportService, "Validates external file types, sanitizes names")
Rel(domainModels, eventStoreAdapter, "Serialize/deserialize JSON payloads")
Rel(desktopShell, collaborationClient, "Shows presence indicators, connection health")
Rel(toolbarService, telemetryClient, "Reports tool activation latency")
Rel(navigatorService, settingsService, "Reads artboard preset catalogs")
Rel(importExportService, featureFlagAdapter, "Gates AI import Tier 2 features")
Rel(replayService, featureFlagAdapter, "Gates timeline scrub enhancements")
Rel(interactionEngine, telemetryClient, "Reports undo stack depth, operation durations")
Rel(backgroundWorkerBridge, settingsService, "Reads snapshot thresholds, PDF quality presets")
Rel(securityGateway, telemetryClient, "Reports auth failures without PII")
@enduml
~~~

<!-- anchor: data-model-overview -->
### 3.6 Data Model Overview & ERD
**Description:** The data model captures immutable Freezed entities mandated by the foundation: Document, Artboard, Layer, VectorObject (Path/Shape/Text/Compound), VectorPath, AnchorPoint, Shape, PathStyle, SelectionState, ViewportState, Event, Snapshot, CollaborationSession, ExportJob, FeatureFlagSetting, SettingsProfile, TelemetryEvent, and supporting references such as thumbnails and presets.
It emphasizes associations such as DocumentArtboard (1:N), ArtboardLayer (1:N), LayerVectorObject (1:N), VectorObjectVectorPath/Shape (1:1), VectorPathAnchorPoint (1:N up to 10,000), plus Event/Snapshot ties for history operations.

**Key Entities:** Document, DocumentMetadata, Artboard, Layer, VectorObject, VectorPath, AnchorPoint, Shape, PathStyle, SelectionState, ViewportState, Event, Snapshot, CollaborationSession, ExportJob, SettingsProfile, FeatureFlagSetting, TelemetryEvent, ThumbnailCache.

~~~plantuml
@startuml
hide circle
skinparam entity {
  BackgroundColor #fafafa
  BorderColor #424242
}
entity "User" as User {
  *id: UUID
  --
  email: String(320)
  displayName: String
  platform: Enum(macOS|Windows)
  createdAt: RFC3339
  lastActiveAt: RFC3339
}
entity "SettingsProfile" as SettingsProfile {
  *id: UUID
  userId: UUID
  samplingIntervalMs: Int
  snapshotEventThreshold: Int
  snapshotTimeThresholdMin: Int
  anchorVisibilityDefault: Enum
  telemetryEnabled: Bool
  undoDepthLimit: Int?
  gridSnapEnabled: Bool
  nudgeDistancePx: Int
}
entity "Document" as Document {
  *id: UUID
  ownerId: UUID
  fileFormatVersion: SemVer
  name: String(200)
  createdAt: RFC3339
  modifiedAt: RFC3339
  anchorVisibilityMode: Enum
  eventCount: Int
  snapshotSequence: Int
}
entity "DocumentMetadata" as DocumentMetadata {
  *documentId: UUID
  author: String
  description: Text?
  tags: JsonArray
  status: Enum(active|archived)
}
entity "Artboard" as Artboard {
  *id: UUID
  documentId: UUID
  name: String(100)
  boundsX: Double
  boundsY: Double
  boundsWidth: Double
  boundsHeight: Double
  backgroundColor: RGBA
  preset: Enum
  zOrder: Int
}
entity "ViewportState" as ViewportState {
  *artboardId: UUID
  zoom: Double
  panX: Double
  panY: Double
}
entity "SelectionState" as SelectionState {
  *artboardId: UUID
  objectIds: JsonArray
  anchorSelections: JsonObject
}
entity "Layer" as Layer {
  *id: UUID
  artboardId: UUID
  name: String(100)
  visible: Bool
  locked: Bool
  zIndex: Int
}
entity "VectorObject" as VectorObject {
  *id: UUID
  layerId: UUID
  artboardId: UUID
  type: Enum(path|shape|text|compound)
  transform: JsonObject
  styleId: UUID
  createdAt: RFC3339
  modifiedAt: RFC3339
}
entity "PathStyle" as PathStyle {
  *id: UUID
  fill: JsonObject?
  stroke: JsonObject?
  opacity: Double
}
entity "VectorPath" as VectorPath {
  *id: UUID
  objectId: UUID
  closed: Bool
  windingRule: Enum
  precisionMeta: JsonObject
}
entity "AnchorPoint" as AnchorPoint {
  *id: UUID
  pathId: UUID
  index: Int
  posX: Double
  posY: Double
  handleInX: Double?
  handleInY: Double?
  handleOutX: Double?
  handleOutY: Double?
  anchorType: Enum
}
entity "Shape" as Shape {
  *id: UUID
  objectId: UUID
  type: Enum(rectangle|ellipse|polygon|star)
  bounds: JsonObject
  parameters: JsonObject
}
entity "Event" as Event {
  *eventId: UUID
  documentId: UUID
  sequence: Int
  artboardId: UUID?
  timestamp: RFC3339
  userId: UUID
  eventType: String
  eventData: JsonObject
  sampledPath: JsonArray?
}
entity "Snapshot" as Snapshot {
  *id: Int
  documentId: UUID
  sequence: Int
  timestamp: RFC3339
  compressed: Bool
  stateData: Blob
}
entity "CollaborationSession" as CollaborationSession {
  *id: UUID
  documentId: UUID
  otBaselineSequence: Int
  websocketChannel: String
  participantIds: JsonArray
  startedAt: RFC3339
  endedAt: RFC3339?
}
entity "ExportJob" as ExportJob {
  *id: UUID
  documentId: UUID
  artboardScope: JsonArray
  format: Enum(SVG|PDF|JSON)
  status: Enum(queued|processing|complete|failed)
  artifactUrl: String?
  warnings: JsonArray
  createdAt: RFC3339
  completedAt: RFC3339?
}
entity "FeatureFlagSetting" as FeatureFlagSetting {
  *id: UUID
  userId: UUID?
  key: String
  environment: String
  defaultValue: JsonValue
  overrides: JsonObject
  lastSyncedAt: RFC3339
}
entity "TelemetryEvent" as TelemetryEvent {
  *id: UUID
  documentId: UUID?
  clientVersion: String
  platform: Enum
  eventType: String
  payload: JsonObject
  timestamp: RFC3339
  telemetryEnabled: Bool
}
entity "ThumbnailCache" as ThumbnailCache {
  *artboardId: UUID
  imageData: Blob
  generatedAt: RFC3339
  refreshIntervalSec: Int
}
User ||--|| SettingsProfile : "owns"
User ||--o{ Document : "creates" 
Document ||--|| DocumentMetadata : "describes"
Document ||--o{ Artboard : "contains"
Artboard ||--|| ViewportState : "stores"
Artboard ||--|| SelectionState : "stores"
Artboard ||--o{ Layer : "groups"
Layer ||--o{ VectorObject : "contains"
VectorObject ||--|| PathStyle : "references"
VectorObject ||--o{ VectorPath : "has"
VectorObject ||--o{ Shape : "may have"
VectorPath ||--o{ AnchorPoint : "anchors"
Document ||--o{ Event : "log"
Document ||--o{ Snapshot : "captures"
Document ||--o{ ExportJob : "spawns"
Document ||--o{ CollaborationSession : "shares"
Document ||--o{ ThumbnailCache : "caches"
CollaborationSession ||--o{ Event : "syncs"
SettingsProfile ||--o{ FeatureFlagSetting : "overrides"
SettingsProfile ||--|| TelemetryEvent : "governs opt-in"
ExportJob ||--|| ObjectStore : "artifact" # line intentionally referencing object storage concept
Event ||--|| User : "authored by"
Snapshot ||--|| User : "requested by"
ThumbnailCache ||--|| ViewportState : "aligned with"
@enduml
~~~

---

<!-- anchor: line-count-guidelines -->
## Structural & Data Architect Output - `02_System_Structure_and_Data.md`

| Project Scale | Line Count | Diagram Complexity |
|---------------|------------|-------------------|
| **Small** | 200-350 lines | - 1 Context diagram (30-40 lines)<br>- 1 Container diagram (40-60 lines)<br>- Simple ERD (20-30 lines)<br>- Minimal component detail |
| **Medium** | 500-800 lines | - Context diagram (50-70 lines)<br>- Container diagram (80-120 lines)<br>- Component diagram (60-100 lines)<br>- Detailed ERD (40-80 lines) |
| **Large** | 1000-1500 lines | - Complex Context (80-120 lines)<br>- Multiple Container views (150-250 lines)<br>- 2-3 Component diagrams (200-300 lines)<br>- Comprehensive ERD (100-150 lines) |
| **Enterprise** | 1800-2500 lines | - Enterprise Context (150-200 lines)<br>- Multiple system boundaries (300-400 lines)<br>- 4-6 Component diagrams (400-600 lines)<br>- Multi-schema ERD (200-300 lines) |

**Content Distribution:**
- Introduction & Goals: 10-15%
- Architectural Drivers: 10-15%
- Diagrams (PlantUML): 50-60%
- Descriptions & Explanations: 20-25%

**Quality Guidelines:**
- MUST adhere to the specified line count range. Diagram content MUST be 50-60% of total lines. All required diagrams (Context, Container, Component, ERD) are MANDATORY. Outputs below minimum are INCOMPLETE. Outputs above maximum are OVER-DETAILED.

<!-- anchor: appendix-structural-deep-dives -->
## Appendix A: Structural Deep Dives

<!-- anchor: appendix-layer-crosswalk -->
### A.1 Layer Responsibility Crosswalk
| Layer | Primary Components | Responsibilities | Key Data Touched | Foundation References |
| --- | --- | --- | --- | --- |
| Presentation | DesktopShell, NavigatorService, ToolbarService | Manages windows, menus, anchors visibility UI, artboard tabs, metrics overlay rendering | View models, thumbnail cache references | Clean Architecture mandate; FR-024, FR-029, FR-033 |
| Application | ToolingFramework, InteractionEngine, RenderingPipeline, SnapshotManager, ReplayService, ImportExportService, SettingsService | Converts gestures to commands, enforces snapping, drives painters, schedules snapshots/replay, orchestrates import/export flows | Domain models, operation metadata, configuration snapshots | FR-001 through FR-050, FR-014, FR-026, FR-046 |
| Domain | Document, Artboard, Layer, VectorObject, VectorPath, AnchorPoint, SelectionState, ViewportState | Immutably represents creative state, ensures serialization parity, enforces constraints (10K anchors etc.) | Freezed DTOs persisted in JSON and SQLite | Section 3.0 Data Models, ADR-001, ADR-003 |
| Infrastructure | EventStoreServiceAdapter, CollaborationClient, FeatureFlagClientAdapter, TelemetryClient, BackgroundWorkerBridge, SecurityGatewayAdapter | Persists events, talks to SQLite/PostgreSQL/Redis, evaluates flags, emits telemetry, secures tokens, executes FFI conversions | SQLite tables, WebSocket payloads, LaunchDarkly config, OT frames | Sections 7.1 and 7.2 of foundation, ADR-002, ADR-004 |
| Platform Integration | QuickLook Extension, Explorer Handler, Installer Pipelines | Provides Finder/Explorer thumbnails, registers shell extensions, ships notarized installers | Snapshot thumbnails, OS metadata, installer artifacts | FR-047, FR-048, Section 2.0 Standard Kit |
| Observability | Telemetry Service, Prometheus exporters, OpenTelemetry spans | Captures FPS, replay rate, snapshot duration, OT latency, crash data | Metrics series, traces, structured logs | NFR-PERF-001..010, NFR-REL-001..004 |
| Collaboration | Collaboration Gateway, Redis Pub/Sub, OT Engine, GraphQL Sync API | Sequences OT transforms, syncs snapshots, handles presence, resolves conflicts | Event streams, session metadata, presence state | Section 7.9, ADR-002 |
| Storage | SQLite, PostgreSQL, Object Storage, Snapshot compression | Supplies durable persistence, migration scripts, artifact retention, JSON exports | Events, snapshots, exports, JSON interchange | Sections 7.6, 7.7, 7.10 |

Additional notes:
- Presentation components read configuration via SettingsService but never retain state beyond view models, preserving hot-reload safety.
- Application components enforce deterministic order; InteractionEngine never touches I/O layers directly, routing through adapters to aid testing.
- Infrastructure adapters encapsulate platform-specific concerns (fsync tuning, TLS contexts) so domain tests remain platform-agnostic.

<!-- anchor: appendix-data-ownership -->
### A.2 Data Ownership Matrix
| Data Object | Source of Truth | Serialization Format | Access Patterns | Retention Strategy |
| --- | --- | --- | --- | --- |
| Document | SQLite `documents` + `state_data` snapshot payload | JSON within SQLite blob + gzip | Loaded on open, mutated via events, serialized in snapshots | Permanent until user deletes; JSON export optionally archived |
| Artboard | Document snapshot (domain) | JSON (Freezed) | Fetched when Navigator opens, mutated via artboard events, cached for thumbnails | Persisted in events + snapshots; thumbnails refreshed every 10s idle |
| Layer | Domain snapshots; derived from artboard events | JSON | Loaded with artboard, filtered per selection/marquee operations | Stored per artboard; limited to 100 layers |
| VectorObject | Domain snapshots + event deltas | JSON describing path/shape/text/compound | Fetched during rendering, selection, export, timeline replay | Immutable event log ensures complete history; pruned only via explicit delete events |
| VectorPath & AnchorPoint | Domain snapshots, event deltas | JSON arrays with double precision coordinates | Accessed by Pen/Direct Selection tool, boolean ops, import/export | Maximum 10,000 anchors per path enforced; events rejected beyond limit |
| SelectionState | Document metadata per artboard | JSON w/ object IDs + anchor maps | Updated on each selection event, isolated per window | Not persisted across artboards; stored per artboard for reopen state |
| ViewportState | Artboard metadata | JSON with zoom/pan, pivot | Saved on viewport change events, restored per window | Persisted per artboard to ensure continuity |
| Event | SQLite `events` table | JSON per payload + metadata columns | Appended after each operation, replayed for undo/redo/history | Stored indefinitely; hashed for integrity; deduped on manual saves |
| Snapshot | SQLite `snapshots` table + object storage replicates | Gzip JSON blob | Created every 500 events/10 minutes/save; read first during load | Background isolate creation; remote copies for collaboration |
| ExportJob | PostgreSQL + object storage | JSON metadata + binary artifact | Created on export, status polled via Sync API, artifact stored in S3 | Expires after 7 days; metadata retained for audit |
| CollaborationSession | PostgreSQL + Redis presence | JSON w/ participants, channel, sequences | Created when multiplayer session starts; updates presence heartbeat | Terminates after idle timeout; audit entries retained |
| FeatureFlagSetting | Feature flag platform + SettingsProfile overrides | JSON | Pulled on startup, cached, optionally overridden per user | Flags reviewed every release; stale flags removed |
| TelemetryEvent | Local log store + Telemetry Service | JSON + OTLP | Emitted asynchronously respecting opt-out | Retained 90 days server-side, local logs rotated |
| ThumbnailCache | Local file system blob cache | PNG/Raw image bytes | Generated by RenderingPipeline; QuickLook/Explorer read caches | Regenerated on save or 10s idle; invalidated on artboard change |

<!-- anchor: appendix-dynamic-diagram -->
### A.3 Dynamic Interaction View (Pen Tool Operation)
**Description:** The dynamic diagram records the structural message flow when a designer adds Bézier anchors with the Pen Tool, demonstrating how Presentation, Application, Domain, and Infrastructure components uphold Clean Architecture boundaries during high-frequency sampling.

~~~plantuml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Dynamic.puml
Person(proDesignerDyn, "Designer")
Container_Boundary(appDyn, "WireTuner Desktop") {
  Component(desktopShellDyn, "DesktopShell")
  Component(toolbarDyn, "ToolbarService")
  Component(toolingDyn, "ToolingFramework")
  Component(interactionDyn, "InteractionEngine")
  Component(renderDyn, "RenderingPipeline")
  Component(eventStoreDyn, "EventStore Adapter")
  Component(snapshotDyn, "SnapshotManager")
  Component(replayDyn, "ReplayService")
  Component(collabDyn, "CollaborationClient")
  Component(telemetryDyn, "TelemetryClient")
}
Container(extSqliteDyn, "SQLite Event Store", "SQLite")
Container(extRedisDyn, "Redis Pub/Sub", "Redis")
' Step numbering ensures clarity across dozens of interactions
Rel_D(proDesignerDyn, desktopShellDyn, "1. Selects Pen Tool via toolbar")
Rel_D(desktopShellDyn, toolbarDyn, "2. ToolbarService activates Pen tool and updates cursor")
Rel_D(toolbarDyn, toolingDyn, "3. ToolingFramework begins path creation session")
Rel_D(toolingDyn, interactionDyn, "4. PointerDown -> CreatePath command issued")
Rel_D(interactionDyn, domain, "5. Domain factory instantiates empty path object")
Rel_D(interactionDyn, renderDyn, "6. RenderingPipeline draws provisional anchor")
Rel_D(interactionDyn, eventStoreDyn, "7. Persist CreatePath event")
Rel_D(eventStoreDyn, extSqliteDyn, "8. INSERT events row with JSON payload")
Rel_D(toolingDyn, interactionDyn, "9. Drag pointer -> Add anchor with handles")
Rel_D(interactionDyn, renderDyn, "10. Re-render active path with preview handles")
Rel_D(interactionDyn, telemetryDyn, "11. Emit sampling latency metric")
Rel_D(interactionDyn, collabDyn, "12. Broadcast OT frame if collaboration active")
Rel_D(collabDyn, extRedisDyn, "13. Publish event to session channel")
Rel_D(collabDyn, interactionDyn, "14. Apply remote acknowledgements")
Rel_D(interactionDyn, snapshotDyn, "15. Notify SnapshotManager of new operation count")
Rel_D(snapshotDyn, eventStoreDyn, "16. Check threshold (500 events) for snapshot")
Rel_D(toolingDyn, interactionDyn, "17. PointerUp -> FinishPath event")
Rel_D(interactionDyn, renderDyn, "18. Commit closed path, update overlays")
Rel_D(interactionDyn, eventStoreDyn, "19. Insert path.closed event")
Rel_D(eventStoreDyn, extSqliteDyn, "20. Persist event to WAL, fsync")
Rel_D(interactionDyn, replayDyn, "21. Register operation boundary for undo stack")
Rel_D(replayDyn, eventStoreDyn, "22. Update operation metadata table")
Rel_D(interactionDyn, snapshotDyn, "23. Idle >200 ms -> auto-save trigger")
Rel_D(snapshotDyn, renderDyn, "24. Request consistent state snapshot")
Rel_D(snapshotDyn, eventStoreDyn, "25. Read latest document state for serialization")
Rel_D(snapshotDyn, backgroundWorkerBridgeDyn, "26. Spawn isolate for snapshot serialization")
Rel_D(backgroundWorkerBridgeDyn, telemetryDyn, "27. Report snapshot duration")
Rel_D(interactionDyn, toolbarDyn, "28. Update status toasts (auto-saved)")
Rel_D(renderDyn, telemetryDyn, "29. FPS counters update overlay metrics")
Rel_D(toolingDyn, desktopShellDyn, "30. Tool completes and resets cursors")
' Additional relationships to emphasize structural safeguards
Rel_D(interactionDyn, securityGateway, "31. Validate file path safety before auto-save flush")
Rel_D(collabDyn, telemetryDyn, "32. Publish network latency metrics for OT frames")
Rel_D(replayDyn, desktopShellDyn, "33. Enable timeline scrubber highlights for new operation")
Rel_D(toolbarDyn, settingsServiceDyn, "34. Apply user-specific sampling preset to Pen tool")
Rel_D(settingsServiceDyn, interactionDyn, "35. Provide grid snapping preferences for shift-drag")
Rel_D(interactionDyn, renderDyn, "36. Request anchor visualization per visibility mode")
Rel_D(toolingDyn, featureFlagDyn, "37. Verify boolean-ops beta not conflicting with Pen tool")
Rel_D(featureFlagDyn, toolbarDyn, "38. Update UI toggles accordingly")
Rel_D(desktopShellDyn, telemetryDyn, "39. Report tool activation latency (goal <50 ms)")
Rel_D(interactionDyn, undoManagerDyn, "40. Push operation onto undo stack respecting depth")
Rel_D(undoManagerDyn, sqliteMetaDyn, "41. Persist stack metadata for crash recovery")
Rel_D(replayDyn, thumbnailServiceDyn, "42. Flag Navigator to refresh artboard thumbnail if idle >10s")
@enduml
~~~

<!-- anchor: appendix-deployment -->
### A.4 Deployment & Storage Footprint Diagram
**Description:** The deployment diagram captures the structural placement of desktops, backend pods, caches, and storage targets mandated by the foundation, emphasizing security zones, autoscaling groups, and where each data set lives.

~~~plantuml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Deployment.puml
AddElementTag("Zone", $bgColor="#f1f8e9", $fontColor="#33691e")
Deployment_Node(macClients, "macOS Clients", "macOS 10.15+", $tags="Zone") {
  Deployment_Node(macHost, "Designer Mac", "Flutter desktop runtime") {
    ContainerInstance(macApp, "WireTuner Desktop", "Flutter 3.x")
    ContainerInstance(macSQLite, "SQLite File", "SQLite WAL")
    ContainerInstance(macQuickLookInst, "QuickLook Plugin", "Swift bundle")
  }
}
Deployment_Node(winClients, "Windows Clients", "Windows 10+", $tags="Zone") {
  Deployment_Node(winHost, "Designer PC", "Flutter desktop runtime") {
    ContainerInstance(winApp, "WireTuner Desktop", "Flutter 3.x")
    ContainerInstance(winSQLite, "SQLite File", "SQLite WAL")
    ContainerInstance(winExplorerInst, "Explorer Handler", "C++/WinRT")
  }
}
Deployment_Node(awsZone, "AWS Cloud", "EKS + Managed Services", $tags="Zone") {
  Deployment_Node(eksCluster, "EKS Cluster", "Kubernetes") {
    ContainerInstance(collabPods, "Collaboration Gateway Pods", "Dart Frog")
    ContainerInstance(syncPods, "Sync API Pods", "Dart Frog")
    ContainerInstance(telemetryIngest, "Telemetry Collector", "Prometheus/OTel")
    ContainerInstance(conversionPods, "resvg Worker Pods", "Rust")
  }
  Deployment_Node(dataServices, "Data Services", "AWS RDS / Elasticache / S3") {
    ContainerInstance(pgInstance, "PostgreSQL", "RDS")
    ContainerInstance(redisInstance, "Redis Cluster", "Elasticache")
    ContainerInstance(s3Bucket, "Artifact Bucket", "S3")
  }
  Deployment_Node(flagServiceZone, "Feature Flag SaaS", "LaunchDarkly/Flagsmith") {
    ContainerInstance(flagApi, "Flag API", "SaaS")
  }
  Deployment_Node(identityZone, "Identity Provider", "Auth0/Okta/OIDC") {
    ContainerInstance(idpApi, "IdP", "SaaS")
  }
  Deployment_Node(observabilityZone, "Observability Stack", "Grafana/Loki/CloudWatch") {
    ContainerInstance(grafanaInst, "Grafana", "Managed")
    ContainerInstance(lokiInst, "Loki", "Managed")
    ContainerInstance(cloudwatchInst, "CloudWatch", "AWS")
  }
}
Rel(macApp, macSQLite, "Reads/writes .wiretuner files")
Rel(macApp, macQuickLookInst, "Shares renderer for thumbnails")
Rel(winApp, winSQLite, "Reads/writes .wiretuner files")
Rel(winApp, winExplorerInst, "Provides thumbnails")
Rel(macApp, collabPods, "WebSocket w/ OT frames", "TLS 1.3")
Rel(winApp, collabPods, "WebSocket w/ OT frames", "TLS 1.3")
Rel(macApp, syncPods, "GraphQL metadata/snapshot", "HTTPS")
Rel(winApp, syncPods, "GraphQL metadata/snapshot", "HTTPS")
Rel(macApp, telemetryIngest, "OpenTelemetry export", "OTLP gRPC")
Rel(winApp, telemetryIngest, "OpenTelemetry export", "OTLP gRPC")
Rel(macApp, flagApi, "Feature flag eval", "HTTPS streaming")
Rel(winApp, flagApi, "Feature flag eval", "HTTPS streaming")
Rel(macApp, idpApi, "Authenticate", "OAuth2/OIDC")
Rel(winApp, idpApi, "Authenticate", "OAuth2/OIDC")
Rel(collabPods, redisInstance, "Pub/Sub", "TLS")
Rel(collabPods, pgInstance, "Session metadata", "TLS")
Rel(syncPods, pgInstance, "Document metadata", "TLS")
Rel(syncPods, s3Bucket, "Snapshots/exports", "S3 API")
Rel(conversionPods, s3Bucket, "Upload PDF outputs", "S3 API")
Rel(conversionPods, redisInstance, "Job queue", "Streams")
Rel(telemetryIngest, grafanaInst, "Metrics visualization")
Rel(telemetryIngest, lokiInst, "Log shipping")
Rel(grafanaInst, opsPersonaDeploy, "Dashboards for Ops_Docs")
Rel(lokiInst, opsPersonaDeploy, "Log queries")
Rel(cloudwatchInst, opsPersonaDeploy, "Alerts")
Rel(flagApi, grafanaInst, "Flag evaluation metrics")
Rel(pgInstance, cloudwatchInst, "RDS metrics/alarms")
Rel(redisInstance, cloudwatchInst, "Cache metrics")
Rel(s3Bucket, cloudwatchInst, "Storage metrics")
Rel(macSQLite, s3Bucket, "Manual backup upload", "User initiated")
Rel(winSQLite, s3Bucket, "Manual backup upload", "User initiated")
Rel(macQuickLookInst, s3Bucket, "Optional pre-rendered thumbnails", "Signed URL")
Rel(winExplorerInst, s3Bucket, "Optional pre-rendered thumbnails", "Signed URL")
Rel(syncPods, grafanaInst, "API metrics")
Rel(collabPods, lokiInst, "Structured logs")
Rel(conversionPods, grafanaInst, "Worker KPIs")
@enduml
~~~

<!-- anchor: appendix-data-integrity -->
## Appendix B: Data Integrity & Migration Notes

<!-- anchor: appendix-event-store-schema -->
### B.1 Event Store Schema Snapshot
```sql
CREATE TABLE documents (
  id TEXT PRIMARY KEY,
  owner_id TEXT NOT NULL,
  name TEXT NOT NULL,
  file_format_version TEXT NOT NULL,
  created_at TEXT NOT NULL,
  modified_at TEXT NOT NULL,
  anchor_visibility_mode TEXT NOT NULL,
  event_count INTEGER NOT NULL DEFAULT 0,
  snapshot_sequence INTEGER NOT NULL DEFAULT 0
);

CREATE TABLE artboards (
  id TEXT PRIMARY KEY,
  document_id TEXT NOT NULL REFERENCES documents(id),
  name TEXT NOT NULL,
  bounds_x REAL NOT NULL,
  bounds_y REAL NOT NULL,
  bounds_width REAL NOT NULL,
  bounds_height REAL NOT NULL,
  background_color TEXT NOT NULL,
  preset TEXT,
  z_order INTEGER NOT NULL,
  thumbnail_timestamp TEXT,
  thumbnail_blob BLOB
);

CREATE TABLE layers (
  id TEXT PRIMARY KEY,
  artboard_id TEXT NOT NULL REFERENCES artboards(id),
  name TEXT NOT NULL,
  visible INTEGER NOT NULL,
  locked INTEGER NOT NULL,
  z_index INTEGER NOT NULL
);

CREATE TABLE events (
  event_id TEXT PRIMARY KEY,
  document_id TEXT NOT NULL REFERENCES documents(id),
  sequence INTEGER NOT NULL UNIQUE,
  artboard_id TEXT,
  timestamp TEXT NOT NULL,
  user_id TEXT NOT NULL,
  event_type TEXT NOT NULL,
  event_data TEXT NOT NULL,
  sampled_path TEXT,
  operation_id TEXT
);

CREATE TABLE snapshots (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  document_id TEXT NOT NULL REFERENCES documents(id),
  sequence INTEGER NOT NULL,
  timestamp TEXT NOT NULL,
  compressed INTEGER NOT NULL,
  state_data BLOB NOT NULL
);

CREATE TABLE export_jobs (
  id TEXT PRIMARY KEY,
  document_id TEXT NOT NULL REFERENCES documents(id),
  artboard_scope TEXT NOT NULL,
  format TEXT NOT NULL,
  status TEXT NOT NULL,
  artifact_url TEXT,
  warnings TEXT,
  created_at TEXT NOT NULL,
  completed_at TEXT
);
```

Notes:
- WAL mode plus `PRAGMA synchronous=EXTRA` ensures durability for crash recovery, aligning with NFR-REL-001.
- Secondary indexes on `events(sequence)` and `snapshots(sequence DESC)` uphold replay and load targets.
- `artboard_scope` remains JSON text (not join table) to keep export queries single-read per requirement FR-041.

<!-- anchor: appendix-snapshot-pipeline -->
### B.2 Snapshot Pipeline Blueprint
```dart
Future<void> maybeCreateSnapshot(Document doc) async {
  final counters = SnapshotCounters(
    eventsSinceLast: doc.eventsSinceSnapshot,
    minutesSinceLast: clock.now().difference(doc.lastSnapshotAt).inMinutes,
  );
  if (!counters.exceedsThresholds()) return;

  final clone = doc.deepCopy(); // Copy-on-write guard per ADR-004
  final compressed = await compute(_serializeSnapshot, clone);
  await sqliteTx((db) async {
    await db.insert('snapshots', compressed.record);
    await db.update('documents', {
      'snapshot_sequence': clone.currentSequence,
      'modified_at': clock.now().toIso8601String(),
    }, where: 'id = ?', whereArgs: [clone.id]);
  });

  telemetry.record('snapshot.duration.ms', compressed.durationMs);
  statusBar.toast('Snapshot created for ${doc.metadata.name}');
}
```

Key safeguards:
1. Deep clone occurs before isolate hand-off to prevent concurrent mutations.
2. Snapshot insertion happens within a SQLite transaction to align metadata updates with blob storage.
3. Telemetry includes duration, size, and memory headroom metrics, feeding alert rules defined in Section 7.7 of the foundation.
4. Status bar notifications differentiate between auto snapshots (subtle) and manual saves (prominent) per FR-014.

<!-- anchor: appendix-sequence-diagram -->
### B.3 Dynamic Sequence Diagram (Save + Snapshot + Export)
**Description:** This sequence view supplements the structural blueprint by showing how save, snapshot, and export flows interact across adapters, ensuring migrations and conversions remain deterministic.

~~~plantuml
@startuml
!pragma teoz true
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Sequence.puml
Person(designerSeq, "Designer")
Component(desktopShellSeq, "DesktopShell")
Component(interactionSeq, "InteractionEngine")
Component(eventStoreSeq, "EventStore Adapter")
Component(snapshotSeq, "SnapshotManager")
Component(settingsSeq, "SettingsService")
Component(importExportSeq, "ImportExportService")
Component(backgroundSeq, "BackgroundWorkerBridge")
Container(collabSeq, "Collaboration Gateway")
Container(syncSeq, "Sync API")
Database(sqliteSeq, "SQLite")
System(queueSeq, "Conversion Queue")
System(storageSeq, "Artifact Storage")

designerSeq -> desktopShellSeq : Cmd/Ctrl+S
note right of desktopShellSeq
Manual save requested
Operation deduplication check begins
end note
desktopShellSeq -> interactionSeq : requestManualSave()
interactionSeq -> eventStoreSeq : flushPendingEvents()
eventStoreSeq -> sqliteSeq : INSERT pending events ; fsync
interactionSeq -> snapshotSeq : triggerManualSnapshot()
snapshotSeq -> backgroundSeq : spawn compute() isolate
backgroundSeq -> snapshotSeq : compressed snapshot blob
snapshotSeq -> sqliteSeq : INSERT snapshot row
snapshotSeq -> interactionSeq : snapshotComplete(sequence)
interactionSeq -> collabSeq : broadcast document.saved event
collabSeq -> syncSeq : annotate remote timeline
interactionSeq -> settingsSeq : mark window clean state
settingsSeq -> desktopShellSeq : remove dirty indicator
interactionSeq -> importExportSeq : optional auto-export? (flagged)
alt Export Requested
  desktopShellSeq -> importExportSeq : userExport(artboardScope, format)
  importExportSeq -> backgroundSeq : enqueueConversionJob()
  backgroundSeq -> queueSeq : push job payload
  queueSeq -> backgroundSeq : pull job
  backgroundSeq -> storageSeq : upload artifact
  storageSeq -> importExportSeq : signed URL
  importExportSeq -> syncSeq : register ExportJob metadata
  syncSeq -> desktopShellSeq : jobComplete(webUrl)
  desktopShellSeq -> designerSeq : toast "Export ready"
else No Export
  desktopShellSeq -> designerSeq : toast "Saved"
end
interactionSeq -> eventStoreSeq : append document.saved event (dedup aware)
eventStoreSeq -> sqliteSeq : INSERT saved event record
interactionSeq -> collabSeq : ACK remote clients
collabSeq -> designerSeq : status "Team updated"
~~~

<!-- anchor: appendix-migration-considerations -->
### B.4 Migration & Integrity Considerations
- **Version Guardrails:** When opening files, Document.fileFormatVersion is evaluated; versions newer than supported raise blocking dialogs referencing Section 4.0 of the requirements, while older versions run migration scripts that produce `.backup.wiretuner` files per NFR-REL-004.
- **Checksum Validation:** Snapshots carry SHA-256 hashes stored in metadata tables; on load, ReplayService recomputes and compares before applying events, surfacing warnings if mismatched (aligns with ADR-001 and NFR-ACC-004).
- **Backup Strategy:** Manual saves optionally stream snapshots to Sync API for remote backup, ensuring large teams with shared infrastructure can recover even if local disks fail.
- **Event Reconciliation:** During OT-driven sessions, Collaboration Gateway assigns authoritative sequence numbers; upon reconnection, clients request `event.sync` payloads referencing last-known sequence and reconcile divergences before allowing edits.
- **Undo Stack Tuning:** ConfigurationService exposes `MAX_UNDO_DEPTH`; when designers request unlimited history, TelemetryClient logs warnings once estimated memory reaches 200 MB so Ops can advise JSON archival.
- **Thumbnail Refresh Policy:** NavigatorService invalidates stale thumbnails via `thumbnail_timestamp`; QuickLook/Explorer handlers read cached bytes and fall back to headless RenderingPipeline executables bundled with installers.
- **Telemetry Opt-Out:** SettingsProfile.telemetryEnabled toggles emission at the source; the adapter writes logs locally and exposes a UI flow for exporting zipped diagnostics without automatic upload, meeting privacy obligations.
- **Security Enforcement:** SecurityGatewayAdapter canonicalizes file paths, enforces `.wiretuner` extensions, and rejects `..` sequences before passing to ImportExportService or EventStoreServiceAdapter, mitigating traversal attacks.
- **Disaster Recovery:** Ops_Docs leverage Sync API backups plus JSON exports to restore corrupted SQLite stores; the restoration process replays snapshots + events and cross-checks state hashes before confirming success.
- **Testing Hooks:** Integration suites seed deterministic event logs, run migrations, and verify bit-identical replays via hashed JSON to guarantee structural stability release over release.

<!-- anchor: appendix-compliance-observability -->
## Appendix C: Compliance & Observability Matrix

<!-- anchor: appendix-compliance -->
### C.1 Requirement-to-Component Trace Matrix
| Requirement ID | Structural Concern | Primary Component(s) | Enforcement Mechanism | Evidence Artifact |
| --- | --- | --- | --- | --- |
| FR-014 Auto-Save & Manual Save | Event persistence, snapshot alignment | InteractionEngine, EventStoreServiceAdapter, SnapshotManager | Idle timer triggers, deduplicated `document.saved` events, snapshot background isolates | Auto-save integration tests, telemetry metric `autosave.duration.ms` |
| FR-024 Anchor Visibility Modes | UI control + overlay piping | ToolbarService, RenderingPipeline, SettingsService | State machine with three modes, persisted metadata, overlay registration/unregistration | Snapshot of metadata table, overlay unit tests |
| FR-029 Navigator Auto-Open | Artboard discovery + UI spawn | NavigatorService, DesktopShell | Document open hook enumerates artboards, ensures Navigator window exists, registers window root lifecycle | Navigator integration test logs, QA checklist |
| FR-033 Viewport Persistence | Artboard metadata + storage | ViewportState, EventStoreServiceAdapter | `artboard.viewport_changed` events carry zoom/pan, saved per artboard, restored on open | Regression scenario automation, snapshot JSON diff |
| FR-039 Thumbnail Refresh | Background renderers | NavigatorService, RenderingPipeline, BackgroundWorkerBridge | Idle timers, save hooks, manual context menu actions schedule thumbnail generation tasks | Telemetry metric `thumbnail.regen.count`, QA recorded video |
| FR-046 Sampling Configuration | Configuration + UI slider | SettingsService, ToolingFramework | Slider + presets adjust config, InteractionEngine reads updated constants, Telemetry logs sampling rate | Settings UI screenshot, config JSON |
| FR-050 Arrow Key Nudging | Input handling + viewport mapping | InteractionEngine, RenderingPipeline | Screen-space delta conversion, intelligent zoom suggestion toasts, telemetry overshoot counters | Input simulation test, telemetry event `nudge.overshoot.count` |
| NFR-PERF-001 Load Time | Snapshot/resume path | EventStoreServiceAdapter, SnapshotManager | Snapshot-first load, event replay limited to delta, Prometheus metric `document.load.ms` | Performance regression dashboard |
| NFR-REL-003 Integrity Check | SQLite health guard | EventStoreServiceAdapter, ReplayService | `PRAGMA integrity_check` on open, hash comparisons, telemetry warnings | Integrity log extracts |
| NFR-USAB-002 Error Clarity | UI messaging | DesktopShell, ToolbarService | Standardized error dialog templates w/ remediation text, localization support | UX copy docs, screenshot evidence |

<!-- anchor: appendix-metrics -->
### C.2 Observability Signals
- **render.fps**: Emitted by RenderingPipeline every second with tags (documentId, artboardId, platform); alerts fire when p95 drops below 58 FPS for target workload.
- **event.replay.rate**: ReplayService reports events/sec whenever timeline scrubbing or load occurs, supporting NFR-PERF-002 tracking.
- **snapshot.duration.ms**: SnapshotManager measures isolate serialization time, compression time, and DB write time; triggers warnings when >500 ms for ≤10 K objects.
- **autosave.duration.ms**: InteractionEngine-to-EventStore round-trip time for auto-save flush; ensures auto-save remains imperceptible.
- **ot.latency.ms**: CollaborationClient calculates round-trip latency to Collaboration Gateway; Ops uses this to scale pods or diagnose network issues.
- **export.job.failures**: ImportExportService increments counters by format (SVG, PDF, JSON, AI) for SLO guardianship.
- **grid.snap.usage.count** and **nudge.overshoot.count**: Derived from InteractionEngine instrumentation, helping UX gauge the effectiveness of screen-space snapping and zoom suggestions.
- **thumbnail.refresh.age**: NavigatorService logs time since last thumbnail update per artboard; stale thumbnails trigger worker tasks and highlight potential performance regressions.
- **telemetry.optout.rate**: TelemetryClient records aggregated on/off percentages so leadership can inspect privacy posture without capturing PII.
- **migration.duration.ms**: EventStoreServiceAdapter measures time to upgrade documents; ensures future migrations stay within acceptable runtime budgets.
- **crash.recovery.success**: Upon relaunch after crash, EventStoreServiceAdapter emits boolean success metric indicating whether auto-save recovery succeeded; correlated with SQLite integrity alerts.

Observability guidance:
- Metrics carry consistent tags: `appVersion`, `platform`, `documentScale`, `featureFlagState` to maintain slicing flexibility across Grafana dashboards.
- All metrics/logs include correlation IDs derived from InteractionEngine to align client spans with backend spans.
- Alert runbooks live with Ops_Docs and reference this appendix plus Section 3 diagrams, enabling responders to map symptoms to structural components quickly.

<!-- anchor: appendix-alert-routing -->
### C.3 Alert Routing Playbook
1. **Detection:** Prometheus alert rules tied to metrics above fire into Alertmanager with labels `severity`, `documentScale`, and `platform`. Each alert message references the corresponding requirement ID so engineers can trace back to this blueprint quickly.
2. **Triage:** Alertmanager routes to Ops_Docs Slack channels; responders consult the C4 diagrams (Sections 3.33.5) to pinpoint which container or component likely misbehaves.
3. **Correlation:** Responders retrieve OpenTelemetry traces filtered by correlation IDs to inspect InteractionEngine  EventStore  SnapshotManager chains, confirming whether issues stem from client, backend, or infrastructure.
4. **Mitigation:** FeatureFlagClientAdapter can disable impacted betas (e.g., advanced typography) within minutes; ConfigurationService overrides allow temporarily relaxing snapshot thresholds or undo depth without redeploying binaries.
5. **Verification:** After mitigation, responders watch metrics to ensure values return within SLAs, document action items, and, if needed, export JSON snapshots for deeper offline analysis.
6. **Postmortem:** Incidents feed ADR updates or specification revisions, keeping the structural blueprint current and preventing drift between architecture intent and implementation reality.

<!-- anchor: appendix-dashboard-links -->
### C.4 Dashboard References
- **Rendering Health Dashboard:** Plots `render.fps`, `nudge.overshoot.count`, GPU fallback toggles; anchors Ops to RenderingPipeline insights referenced in Section 3.5.
- **Persistence & Replay Dashboard:** Tracks `snapshot.duration.ms`, `event.replay.rate`, `migration.duration.ms`, and SQLite integrity outcomes; backlinked to ERD entities for schema context.
- **Collaboration Pulse Dashboard:** Monitors `ot.latency.ms`, `collab.gateway.cpu`, Redis pub/sub backlog, and WebSocket error ratios, mapping directly to containers in Section 3.4.
- **Export Reliability Dashboard:** Visualizes ExportJob throughput, conversion worker utilization, and PDF/SVG error codes, enabling ImportExportService owners to react quickly.
- **Platform Integration Dashboard:** Aggregates QuickLook/Explorer refresh metrics, installer download counts, and telemetry opt-out rates segregated by platform.
- **Alert Drill-Down Dashboard:** Provides correlation ID search, feature flag states, and ConfigurationService overrides so responders can reconstruct timeline leading to each alert.
These dashboards are versioned with the architecture blueprint so every release can trace observability changes back to structural intent.
